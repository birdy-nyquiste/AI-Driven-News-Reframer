<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ task.title }} - AI-Driven News Reframer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Task Details</h1>
        </div>

        <div class="main-content">
            <div class="content-box">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <!-- Task Header -->
                <div class="task-header">
                    <h2 class="task-title">{{ task.title }}</h2>
                </div>

                <!-- Task Summary -->
                <div class="info-box">
                    <div class="summary-item">
                        <span class="summary-label">Sources:</span>
                        <span class="summary-value">{{ task.articles|length }} files</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Instruction:</span>
                        <span class="summary-value">
                            {% if task.preset_instruction %}
                                Preset: {{ task.preset_instruction.title() }}
                            {% elif task.instruction %}
                                {{ task.instruction[:50] + "..." if task.instruction|length > 50 else task.instruction }}
                            {% else %}
                                No instruction provided
                            {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="section">
                    <div style="text-align: center; margin-bottom: var(--space-6);">
                        <div class="status-badge status-{{ task.status }}">
                            {% if task.status == 'processing' %}
                            <span class="spinner"></span>
                            {% endif %}
                            {{ task.status.title() }}
                        </div>
                    </div>

                    {% if task.status == 'pending' %}
                    <div class="info-box" id="pending-info">
                        <h3>Ready to Process</h3>
                        <p>Your task is ready. Click "Start Processing" to begin rewriting your sources using Google Gemini AI.</p>
                    </div>
                    
                    <!-- Processing indicator (initially hidden) -->
                    <div class="info-box" id="processing-info" style="display: none;">
                        <h3>Processing in Progress...</h3>
                        <p>Your sources are being processed by Google Gemini AI. This may take a few moments.</p>
                        
                        <!-- Progress bar -->
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill indeterminate"></div>
                            </div>
                            <div class="progress-text">Processing sources...</div>
                        </div>
                        
                        <!-- Processing steps -->
                        <div class="processing-steps">
                            <div class="processing-step active">
                                <div class="step-icon active">1</div>
                                <span>Analyzing sources</span>
                            </div>
                            <div class="processing-step">
                                <div class="step-icon pending">2</div>
                                <span>Applying reframing instructions</span>
                            </div>
                            <div class="processing-step">
                                <div class="step-icon pending">3</div>
                                <span>Generating final content</span>
                            </div>
                        </div>
                        
                        <p style="font-size: 0.875rem; color: var(--neutral-500); font-style: italic; margin-bottom: 0;">This page will automatically refresh every 5 seconds.</p>
                    </div>
                    
                    {% elif task.status == 'processing' %}
                    <div class="info-box">
                        <h3>Processing in Progress...</h3>
                        <p>Your sources are being processed by Google Gemini AI. This may take a few moments.</p>
                        
                        <!-- Progress bar -->
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill indeterminate"></div>
                            </div>
                            <div class="progress-text">Processing sources...</div>
                        </div>
                        
                        <!-- Processing steps -->
                        <div class="processing-steps">
                            <div class="processing-step completed">
                                <div class="step-icon completed">âœ“</div>
                                <span>Analyzing sources</span>
                            </div>
                            <div class="processing-step active">
                                <div class="step-icon active">2</div>
                                <span>Applying reframing instructions</span>
                            </div>
                            <div class="processing-step">
                                <div class="step-icon pending">3</div>
                                <span>Generating final content</span>
                            </div>
                        </div>
                        
                        <p style="font-size: 0.875rem; color: var(--neutral-500); font-style: italic; margin-bottom: 0;">This page will automatically refresh every 5 seconds.</p>
                    </div>
                    {% elif task.status == 'failed' %}
                    <div class="info-box" style="border-left-color: var(--error-500); background-color: var(--error-50);">
                        <h3 style="color: var(--error-600);">Processing Failed</h3>
                        <p>{{ task.result if task.result else "An error occurred while processing your task." }}</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Result Section -->
                {% if task.status == 'completed' and task.result %}
                <div class="section">
                    <h3 class="section-title">Generated Content</h3>
                    <div class="form-group">
                        <textarea class="form-textarea" readonly rows="20" style="font-family: var(--font-family-mono); background-color: var(--neutral-50);">{{ task.result }}</textarea>
                    </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="{{ url_for('task.new_task') }}" class="btn btn-secondary">Back to Tasks</a>
                    
                    {% if task.status == 'pending' %}
                    <form id="process-form" action="{{ url_for('task.process_task', task_id=task.task_id) }}" method="POST" style="display: inline;">
                        <button type="submit" id="process-btn" class="btn btn-primary">Start Processing</button>
                    </form>
                    {% elif task.status == 'failed' %}
                    <form id="process-form" action="{{ url_for('task.process_task', task_id=task.task_id) }}" method="POST" style="display: inline;">
                        <button type="submit" id="process-btn" class="btn btn-primary">Retry Processing</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for immediate processing feedback -->
    {% if task.status == 'pending' or task.status == 'failed' %}
    <script>
        // Handle form submission with immediate feedback
        document.getElementById('process-form').addEventListener('submit', function(e) {
            const button = document.getElementById('process-btn');
            const statusBadge = document.querySelector('.status-badge');
            const pendingInfo = document.getElementById('pending-info');
            const processingInfo = document.getElementById('processing-info');
            
            // Update button state
            button.classList.add('loading');
            button.textContent = 'Processing...';
            
            // Update status badge
            statusBadge.className = 'status-badge status-processing';
            statusBadge.innerHTML = '<span class="spinner"></span> Processing';
            
            // Show processing info and hide pending info
            if (pendingInfo) pendingInfo.style.display = 'none';
            if (processingInfo) processingInfo.style.display = 'block';
            
            // Animate processing steps
            setTimeout(function() {
                animateProcessingSteps();
            }, 1000);
        });
        
        function animateProcessingSteps() {
            const steps = document.querySelectorAll('.processing-step');
            const icons = document.querySelectorAll('.step-icon');
            
            // Simulate step progression
            let currentStep = 0;
            
            const stepInterval = setInterval(function() {
                if (currentStep < steps.length - 1) {
                    // Mark current step as completed
                    steps[currentStep].classList.remove('active');
                    steps[currentStep].classList.add('completed');
                    icons[currentStep].classList.remove('active');
                    icons[currentStep].classList.add('completed');
                    icons[currentStep].textContent = 'âœ“';
                    
                    currentStep++;
                    
                    // Activate next step
                    if (currentStep < steps.length) {
                        steps[currentStep].classList.add('active');
                        icons[currentStep].classList.remove('pending');
                        icons[currentStep].classList.add('active');
                    }
                }
                
                // Update progress text
                const progressText = document.querySelector('.progress-text');
                if (progressText) {
                    const messages = [
                        'Analyzing source articles...',
                        'Applying rewriting instructions...',
                        'Generating final article...'
                    ];
                    if (currentStep < messages.length) {
                        progressText.textContent = messages[currentStep];
                    }
                }
                
                if (currentStep >= steps.length - 1) {
                    clearInterval(stepInterval);
                }
            }, 2000); // Change step every 2 seconds
        }
    </script>
    {% endif %}
        
    <!-- Auto-refresh for processing status -->
    {% if task.status == 'processing' %}
    <script>
        setTimeout(function() {
            window.location.reload();
        }, 5000); // Refresh every 5 seconds
    </script>
    {% endif %}
</body>

</html>
